<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search</title>
    <link rel="stylesheet" href="searchstyle.css">
</head>
<body>
    <button onclick ="location.href='index.html'">Home</button>
    <h1><u>Search for Recipes</u></h1>
    <form action = "HandleInput.java" method = "post">
        <label for="Allergens">Allergens:</label>
        <select id="Allergens">
            <option value="Gluten">Gluten</option>
            <option value="Lactose">Lactose</option>
            <option value="Gluten">Gluten</option>
            <option value="Nuts">Nuts</option>
            <option value="Eggs">Eggs</option>
            <option value="Sugar">Sugar</option>
            <option value="None">None</option>
        </select>
        <label for="CookMethod">Cook Method:</label>
        <select id="CookMethod">
            <option value="Oven">Oven</option>
            <option value="Stove">Stove</option>
            <option value="Air Fryer">Air Fryer</option>
            <option value="Microwave">Microwave</option>
            <option value="No Cook">No Cook</option>
            <option value="Fridge">Fridge</option>
            <option value="Dorm">Dorm</option>
            <option value="All">All</option>
        </select>
        <br>
       <button type="button" onclick="saveAndReload()">Submit</button>
    </form>
<div id="status">Loading...</div>
<div id="recipeBox"></div>
    <div id="recipeDisplay"></div>
</div>

<script>
// Function to save form data to sessionStorage before reloading
    function saveAndReload() {
        const inputElements = document.querySelectorAll('input, select, textarea');
        inputElements.forEach(element => {
            sessionStorage.setItem(element.id || element.name, element.value);
        });
        window.location.reload();
    }

    // Function to restore form data from sessionStorage on page load
    window.onload = function() {
        const inputElements = document.querySelectorAll('input, select, textarea');
        inputElements.forEach(element => {
            const storedValue = sessionStorage.getItem(element.id || element.name);
            if (storedValue !== null) {
                if (element.type === 'checkbox' || element.type === 'radio') {
                    element.checked = (storedValue === 'true');
                } else {
                    element.value = storedValue;
                }
            }
        });
        // Optional: Clear storage after restoration if you don't want data to persist across *manual* refreshes
        // sessionStorage.clear(); 
    }

const csvUrl = "recipeOut.csv";

fetch(csvUrl)
    .then(response => response.text())
    .then(csvText => {
        document.getElementById("status").textContent = "Recipes Available";

        // Get 
        const allergenIn = document.getElementById('Allergens');
        var allergenVal = allergenIn.value;
        if (allergenVal == "None") {
            allergenVal = "a";
        }
        const cookMethodIn = document.getElementById('CookMethod');
        const cookMethodVal = cookMethodIn.value;

        // Clean CSV text and split into lines
        const lines = csvText.trim().split(/\r?\n/).filter(line => line.trim() !== "");

        // Initialize HTML string
        let html = "";

        // Loop through all lines (all recipes)
        lines.forEach(line => {
            const values = line.split(",");
            var add = true;

            const id = values[0] || "";
            const name = values[1] || "";
            var ingredient = values[2] || "";
            var ingredients = ""
            while (ingredient.indexOf("_") > 0) {
                ingredients += ingredient.substring(0, ingredient.indexOf("_")) + ", ";
                ingredient = ingredient.substring(ingredient.indexOf("_") + 1);
            }
            ingredients += ingredient;

            const cookingTime = values[3] || "";
            const cookMethod = values[4] || "";
            var allergen = values[5] || "";
            var allergens = "";
            var checkAllergen = "";
            while (allergen.indexOf("_") > 0) {
                checkAllergen = allergen.substring(0, allergen.indexOf("_"))
                allergens += checkAllergen + ", ";
                if (checkAllergen == allergenVal) {
                    add = false;
                }
                allergen = allergen.substring(allergen.indexOf("_") + 1);
            }
            if (allergen.trim() == allergenVal.trim()) {
                add = false;
            }
            allergens += allergen;


            const instructions = values.slice(6).join(",") || "";
            if (cookMethodVal == "All" && add) {
                html += `
                <div class = "recipe">
                    <div class="varBox"><strong>Name:</strong> ${name}</div>
                    <div class="varBox"><strong>Ingredient List:</strong> ${ingredients}</div>
                    <div class="varBox"><strong>Cooking Time:</strong> ${cookingTime}</div>
                    <div class="varBox"><strong>Cooking Method:</strong> ${cookMethod}</div>
                    <div class="varBox"><strong>Allergens:</strong> ${allergens}</div>
                    <div class="varBox"><strong>Instructions:</strong> ${instructions}</div>
                </div>
            `;
            } else if (cookMethodVal == "Dorm" && (cookMethod == "Microwave" || cookMethod == "Fridge" || cookMethod == "No Cook") && add) {
                html += `
                <div id= "recipeDisplay">
                    <div class = "recipe">
                        <div class="varBox"><strong>Name:</strong> ${name}</div>
                        <div class="varBox"><strong>Ingredient List:</strong> ${ingredients}</div>
                        <div class="varBox"><strong>Cooking Time:</strong> ${cookingTime}</div>
                        <div class="varBox"><strong>Cooking Method:</strong> ${cookMethod}</div>
                        <div class="varBox"><strong>Allergens:</strong> ${allergens}</div>
                        <div class="varBox"><strong>Instructions:</strong> ${instructions}</div>
                    </div>
                </div>
            `;
            } else if (cookMethod == cookMethodVal && add) {
                html += `
                <div id= "recipeDisplay">
                    <div class = "recipe">
                        <div class="varBox"><strong>Name:</strong> ${name}</div>
                        <div class="varBox"><strong>Ingredient List:</strong> ${ingredients}</div>
                        <div class="varBox"><strong>Cooking Time:</strong> ${cookingTime}</div>
                        <div class="varBox"><strong>Cooking Method:</strong> ${cookMethod}</div>
                        <div class="varBox"><strong>Allergens:</strong> ${allergens}</div>
                        <div class="varBox"><strong>Instructions:</strong> ${instructions}</div>
                    </div>
                </div>
            `;
            } 

        });

        // Insert all recipes into the page
        document.getElementById("recipeDisplay").innerHTML = html;
    })
    .catch(err => {
        document.getElementById("status").textContent = "Error loading recipeOut.csv";
        console.error(err);
    });
</script>
</body>
</html>